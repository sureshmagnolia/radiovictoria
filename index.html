<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Radio Debugger</title>
    <link rel="icon" href="data:,">
    <style>
        body { background: #222; color: #fff; font-family: sans-serif; text-align: center; padding: 50px; }
        .box { border: 1px solid #444; padding: 20px; display: inline-block; border-radius: 10px; }
        button { padding: 10px 20px; font-size: 1.2rem; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 5px; margin-top: 10px;}
        button:disabled { background: #555; cursor: wait; }
        #logs { text-align: left; background: #000; color: #0f0; padding: 10px; margin-top: 20px; height: 150px; overflow-y: scroll; font-family: monospace; font-size: 0.8rem; border: 1px solid #333; }
        .error { color: #ff5555; }
    </style>
</head>
<body>

    <div class="box">
        <h1>ðŸ“» Radio Tester</h1>
        <h3 id="track-name">Initializing...</h3>
        
        <audio id="audioPlayer" controls style="width: 300px; margin-top: 10px;"></audio>
        <br>
        <button id="playBtn" onclick="userClickedPlay()" disabled>â–¶ Start Radio</button>
    </div>

    <div id="logs">System Log...<br></div>

    <script>
        // --- SETTINGS ---
        const API_URL = "https://script.google.com/macros/s/AKfycbx7q6J792WigaJ0gK3HnyRPs4NQI04h1dK5-fUxKBfcjXd97rtqckYKmLxy_SOOij_Zow/exec"; 
        // ----------------

        let playlist = [];
        let currentIndex = 0;
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const trackLabel = document.getElementById('track-name');
        const logBox = document.getElementById('logs');

        function log(msg, isError = false) {
            const span = document.createElement('div');
            span.innerText = "> " + msg;
            if (isError) span.className = "error";
            logBox.appendChild(span);
            console.log(msg);
        }

        // 1. Fetch Playlist
        async function fetchPlaylist() {
            log("Connecting to Google Drive...");
            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (data.error) {
                    log("ERROR from Script: " + data.error, true);
                    return;
                }

                playlist = data;
                log(`Success! Received ${playlist.length} tracks.`);

                if (playlist.length === 0) {
                    log("WARNING: Playlist is empty! Check Folder Content.", true);
                    trackLabel.innerText = "Folder is Empty";
                } else {
                    log("First track: " + playlist[0].name);
                    log("First URL: " + playlist[0].url); // Inspect this URL in console
                    playBtn.disabled = false;
                    playBtn.innerText = "â–¶ Start Radio";
                    trackLabel.innerText = "Ready to Play";
                    
                    // Pre-load the first track (but don't play yet)
                    audio.src = playlist[0].url;
                    audio.load();
                }

            } catch (error) {
                log("NETWORK ERROR: " + error.message, true);
                trackLabel.innerText = "Connection Failed";
            }
        }

        // 2. Play Function (Must be triggered by button first)
        function userClickedPlay() {
            log("User clicked Play. Attempting to start...");
            playTrack(currentIndex);
        }

        function playTrack(index) {
            if (playlist.length === 0) return;

            // Loop logic
            if (index >= playlist.length) currentIndex = 0;
            else currentIndex = index;

            const track = playlist[currentIndex];
            
            log(`Loading: ${track.name}`);
            trackLabel.innerText = "Playing: " + track.name;

            // CRITICAL: Check if URL is valid before playing
            if (!track.url) {
                log("ERROR: Track URL is missing!", true);
                return;
            }

            audio.src = track.url;
            
            // Promise handling to catch the "NotSupportedError"
            var playPromise = audio.play();

            if (playPromise !== undefined) {
                playPromise.then(_ => {
                    log("Audio started playing successfully.");
                    playBtn.style.display = "none"; // Hide button after success
                })
                .catch(error => {
                    log("PLAYBACK ERROR: " + error.name + " - " + error.message, true);
                    if(error.name === "NotSupportedError") {
                         log("HINT: The URL might be redirecting to a login page. Check Drive Permissions.", true);
                    }
                });
            }
        }

        // Auto-play next
        audio.addEventListener('ended', () => {
            log("Track ended. Playing next...");
            playTrack(currentIndex + 1);
        });

        // Error listener on the audio tag itself
        audio.addEventListener('error', (e) => {
            log("AUDIO TAG ERROR CODE: " + audio.error.code, true);
            log("Meaning: 1=Aborted, 2=Network, 3=Decode, 4=SrcNotSupported", true);
        });

        // Init
        fetchPlaylist();

    </script>
</body>
</html>
